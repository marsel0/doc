---
title: "Система рандомизации"
---
В один момент не может быть на реквизите больше 1 заявки на 1 сумму, при этом большинство ордеров поступают на одинаковые суммы, например 1000рублей. Чтобы расширить пул реквизитов,  внедряем систему рандомизации сумм. 

Как это работает:
В настройках магазина задается диапазон для рандомизации (мин / макс спред), шаг изменения суммы и пределы рандомизации (мин / макс сумма).
Например, от 100 до 10000 рублей. Если значение 95 рублей или 10001 рубль, сумма не разбивается.

Крайние значения (для спреда и для пределов рандомизации) включаются в диапазон.

Когда клиент пытается оплатить заказ на фиксированную сумму, например, 1000 рублей, система рандомизирует сумму в заданном диапазоне, изменяя ее на заданный шаг, например, 1 рубль. Ордер создается на сумму, максимально приближенную к изначальной сумме ордера. Сначала система пробует (сумма ордера + шаг), затем (сумма ордера - шаг), затем (сумма ордера + шаг*2) и так далее.

Если баланса на большую сумму не хватает, ордер создается на меньшую возможную сумму.

Все комиссии начисляются от фактической суммы заказа.

Пример: 

- **Мин отклонение = 50**

- **Макс отклонение = 50**

- Шаг  1

- Сумма заказа 1000 рублей. 

- Фактическая сумма заказа: подбор начинается с 1001, затем 999, 1002 итд

**Что необходимо сделать:**
1.Добавить в настройки магазина новый раздел с пятью полями и чекбоксом: 

**Рандомизация суммы Payin ордера**

**Допускать рандомизацию Payin ордера** - включение/выключение фичи.

- **Минимальное отклонение** — нижний предел диапазона для рандомизации суммы.

- **Максимальное отклонение** — верхний предел диапазона.

- **Шаг рандомизации** — величина, на которую будет изменяться сумма заказа.

- **Пределы рандомизации: мин** — минимальное значение суммы ордера, для которого производится рандомизация.

- **Пределы рандомизации: макс** —  максимальное значение суммы ордера, для которого производится рандомизация.

Валидация полей: только целый, шаг меньше (макс отклонение+мин отклонение)

2. Поле доступно для редактирования администраторам, тех.операторам.

3. Автоматически корректировать суммы заказов в пределах рандомизации, в рамках заданного диапазона (сумма в руб, сумма в USDT)

4. Сохранять в БД оригинальную и фактическую сумму заказа.

5. Показывать на SCI фактическую сумму заказа с учетом рандомизации: поле amount, поле в USDT.

6. Автотесты

**Алгоритм:** 

- get Distribution, возвращаем реквизит и сумму

- если сумма изменилась делаем изменение суммы и доп начисление asset-а
